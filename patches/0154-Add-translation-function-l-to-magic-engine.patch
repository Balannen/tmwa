From aeb6925b7b0fc9f7fdf61b9b27aa9dfdb53b5469 Mon Sep 17 00:00:00 2001
From: Andrei Karas <akaras@inbox.ru>
Date: Wed, 29 Dec 2010 21:23:33 +0200
Subject: [PATCH 154/226] Add translation function l to magic engine.

example: l(caster, "text")
---
 src/map/Makefile     |  6 +++---
 src/map/magic-expr.c | 13 +++++++++++++
 2 files changed, 16 insertions(+), 3 deletions(-)

diff --git a/src/map/Makefile b/src/map/Makefile
index 8cee37a..40fab1c 100644
--- a/src/map/Makefile
+++ b/src/map/Makefile
@@ -26,10 +26,10 @@ magic-interpreter-parser.c: magic-interpreter-parser.y
 obj/magic-interpreter-lexer.o: magic-interpreter-lexer.c magic-interpreter-parser.c magic-expr.h magic-interpreter.h chrif.h clif.h npc.h pc.h mob.h chat.h skill.h itemdb.h storage.h party.h atcommand.h ../common/core.h ../common/timer.h ../common/db.h ../common/grfio.h ../common/mmo.h
 obj/magic-interpreter-parser.o: magic-interpreter-parser.c magic-expr.h magic-interpreter.h chrif.h clif.h npc.h pc.h mob.h chat.h skill.h itemdb.h storage.h party.h atcommand.h ../common/core.h ../common/timer.h ../common/db.h ../common/grfio.h ../common/mmo.h
 obj/magic-interpreter-base.o: magic-interpreter-base.c magic-expr-eval.h magic-interpreter-aux.h magic-expr.h magic-interpreter.h chrif.h clif.h npc.h pc.h mob.h chat.h skill.h itemdb.h storage.h party.h atcommand.h ../common/core.h ../common/timer.h ../common/db.h ../common/grfio.h ../common/mmo.h
-obj/magic-expr.o: magic-expr.c magic-expr-eval.h magic-interpreter-aux.h magic-expr.h magic-interpreter.h chrif.h clif.h npc.h pc.h mob.h chat.h skill.h itemdb.h storage.h party.h atcommand.h ../common/core.h ../common/timer.h ../common/db.h ../common/grfio.h ../common/mmo.h
+obj/magic-expr.o: magic-expr.c lang.h magic-expr-eval.h magic-interpreter-aux.h magic-expr.h magic-interpreter.h chrif.h clif.h npc.h pc.h mob.h chat.h skill.h itemdb.h storage.h party.h atcommand.h ../common/core.h ../common/timer.h ../common/db.h ../common/grfio.h ../common/mmo.h
 obj/magic-stmt.o: magic-stmt.c magic-expr-eval.h magic-interpreter-aux.h magic-expr.h magic-interpreter.h chrif.h clif.h npc.h pc.h mob.h chat.h skill.h itemdb.h storage.h party.h atcommand.h ../common/core.h ../common/timer.h ../common/db.h ../common/grfio.h ../common/mmo.h
 obj/magic.o: magic.c magic.h magic-expr.h magic-interpreter.h chrif.h clif.h npc.h pc.h mob.h chat.h skill.h itemdb.h storage.h party.h atcommand.h ../common/core.h ../common/timer.h ../common/db.h ../common/grfio.h ../common/mmo.h
-obj/map.o: map.c map.h lang.c lang.h chrif.h clif.h npc.h pc.h mob.h chat.h skill.h itemdb.h storage.h party.h atcommand.h ../common/core.h ../common/timer.h ../common/db.h ../common/grfio.h ../common/mmo.h
+obj/map.o: map.c map.h lang.h chrif.h clif.h npc.h pc.h mob.h chat.h skill.h itemdb.h storage.h party.h atcommand.h ../common/core.h ../common/timer.h ../common/db.h ../common/grfio.h ../common/mmo.h
 obj/lang.o: lang.c lang.h ../common/core.h ../common/timer.h ../common/db.h ../common/grfio.h ../common/mmo.h
 obj/chrif.o: chrif.c map.h battle.h chrif.h clif.h intif.h pc.h npc.h ../common/socket.h ../common/timer.h ../common/mmo.h
 obj/clif.o: magic.h clif.c map.h chrif.h clif.h mob.h intif.h pc.h npc.h itemdb.h chat.h script.h storage.h party.h guild.h atcommand.h atcommand.h ../common/socket.h ../common/timer.h ../common/mmo.h ../common/version.h tmw.h
@@ -39,7 +39,7 @@ obj/chat.o: chat.c map.h clif.h pc.h chat.h ../common/db.h ../common/mmo.h
 obj/path.o: path.c map.h battle.h ../common/mmo.h
 obj/itemdb.o: itemdb.c map.h battle.h itemdb.h ../common/db.h ../common/grfio.h ../common/mmo.h
 obj/mob.o: mob.c map.h clif.h intif.h pc.h mob.h skill.h battle.h npc.h itemdb.h ../common/timer.h ../common/socket.h ../common/mmo.h
-obj/script.o: script.c lang.c lang.h itemdb.h map.h pc.h mob.h clif.h intif.h npc.h script.h storage.h skill.h battle.h ../common/timer.h ../common/socket.h ../common/db.h ../common/mmo.h ../common/lock.h
+obj/script.o: script.c lang.h itemdb.h map.h pc.h mob.h clif.h intif.h npc.h script.h storage.h skill.h battle.h ../common/timer.h ../common/socket.h ../common/db.h ../common/mmo.h ../common/lock.h
 obj/storage.o: storage.c itemdb.h pc.h clif.h intif.h storage.h guild.h ../common/mmo.h ../common/db.h
 obj/skill.o: skill.c skill.h map.h clif.h pc.h mob.h battle.h itemdb.h script.h ../common/timer.h ../common/mmo.h
 obj/skill-pools.o: skill-pools.c skill.h map.h clif.h pc.h mob.h battle.h itemdb.h script.h ../common/timer.h ../common/mmo.h
diff --git a/src/map/magic-expr.c b/src/map/magic-expr.c
index 41c4a7a..21a68ca 100644
--- a/src/map/magic-expr.c
+++ b/src/map/magic-expr.c
@@ -1,6 +1,7 @@
 #include "magic-expr.h"
 #include "magic-expr-eval.h"
 #include "itemdb.h"
+#include "lang.h"
 #include <math.h>
 
 #define IS_SOLID(c) ((c) == 1 || (c) == 5)
@@ -1425,6 +1426,17 @@ fun_extract_healer_xp (env_t * env __attribute__ ((unused)), int args_nr __attri
     return 0;
 }
 
+static int fun_lang_translate (env_t * env __attribute__ ((unused)), int args_nr __attribute__ ((unused)), val_t * result, val_t * args)
+{
+    if (!result || !args)
+        return 1;
+
+    character_t *sd = (ETY (0) == BL_PC) ? ARGPC (0) : NULL;
+
+    RESULTSTR = strdup(lang_pctrans(ARGSTR (1), sd));
+    return 0;
+}
+
 #define BATTLE_RECORD2(sname, name) { sname, "e", 'i', fun_get_##name }
 #define BATTLE_RECORD(name) BATTLE_RECORD2(#name, name)
 static fun_t functions[] = {
@@ -1503,6 +1515,7 @@ static fun_t functions[] = {
     {"is_dead", "e", 'i', fun_is_dead},
     {"is_pc", "e", 'i', fun_is_pc},
     {"extract_healer_experience", "ei", 'i', fun_extract_healer_xp},
+    {"l", "es", 's', fun_lang_translate},
     {NULL, NULL, '.', NULL}
 };
 
-- 
2.1.0

