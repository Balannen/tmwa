From 2f1e32b98ebd75b1136ff3067b737bedc12731b9 Mon Sep 17 00:00:00 2001
From: Andrei Karas <akaras@inbox.ru>
Date: Mon, 6 Dec 2010 19:38:29 +0200
Subject: [PATCH 093/226] Impliment mob spawn limit by skills for each master.

Config parameter mob_skill_spawn_limit.
---
 src/map/battle.c |  6 ++++++
 src/map/battle.h |  1 +
 src/map/mob.c    | 12 ++++++++++++
 3 files changed, 19 insertions(+)

diff --git a/src/map/battle.c b/src/map/battle.c
index f2c9a50..5de2baa 100644
--- a/src/map/battle.c
+++ b/src/map/battle.c
@@ -5541,6 +5541,7 @@ int battle_config_read (const char *cfgName)
         battle_config.mob_skill_use = 1;
         battle_config.mob_count_rate = 100;
         battle_config.mob_map_limit = 500;
+        battle_config.mob_skill_spawn_limit = 30;
         battle_config.quest_skill_learn = 0;
         battle_config.quest_skill_reset = 1;
         battle_config.basic_skill_check = 1;
@@ -5835,6 +5836,8 @@ int battle_config_read (const char *cfgName)
             {
             "mob_map_limit", &battle_config.mob_map_limit},
             {
+            "mob_skill_spawn_limit", &battle_config.mob_skill_spawn_limit},
+            {
             "quest_skill_learn", &battle_config.quest_skill_learn},
             {
             "quest_skill_reset", &battle_config.quest_skill_reset},
@@ -6309,6 +6312,9 @@ int battle_config_read (const char *cfgName)
         if (battle_config.mob_map_limit < 1)
             battle_config.mob_map_limit = 1;
 
+        if (battle_config.mob_skill_spawn_limit < 1)
+            battle_config.mob_skill_spawn_limit = 1;
+
         add_timer_func_list (battle_delay_damage_sub,
                              "battle_delay_damage_sub");
     }
diff --git a/src/map/battle.h b/src/map/battle.h
index bececed..c42193a 100644
--- a/src/map/battle.h
+++ b/src/map/battle.h
@@ -201,6 +201,7 @@ extern struct Battle_Config
     int  mob_skill_use;
     int  mob_count_rate;
     int  mob_map_limit;
+    int  mob_skill_spawn_limit;
     int  quest_skill_learn;
     int  quest_skill_reset;
     int  basic_skill_check;
diff --git a/src/map/mob.c b/src/map/mob.c
index d83f1f0..56840ff 100644
--- a/src/map/mob.c
+++ b/src/map/mob.c
@@ -3620,10 +3620,14 @@ int mob_summonslave (struct mob_data *md2, int *value, int amount, int flag)
     if (count < 1)
         return 0;
 
+    if (mob_countslave (md2) > battle_config.mob_skill_spawn_limit)
+        return 0;
+
     for (k = 0; k < count; k++)
     {
         amount = a;
         class = value[k];
+
         if (class <= 1000 || class > 2000)
             continue;
 
@@ -4433,15 +4437,23 @@ int mobskill_use (struct mob_data *md, unsigned int tick, int event)
                     flag = !map[md->bl.m].flag.town;
                     break;
                 case MSC_SLAVELT:  // slave < num
+                    if (c2 > battle_config.mob_skill_spawn_limit)
+                        c2 = battle_config.mob_skill_spawn_limit;
                     flag = (mob_countslave (md) < c2);
                     break;
                 case MSC_ATTACKPCGT:   // attack pc > num
+                    if (c2 > battle_config.mob_skill_spawn_limit)
+                        c2 = battle_config.mob_skill_spawn_limit;
                     flag = (mob_counttargeted (md, NULL, 0) > c2);
                     break;
                 case MSC_SLAVELE:  // slave <= num
+                    if (c2 > battle_config.mob_skill_spawn_limit)
+                        c2 = battle_config.mob_skill_spawn_limit;
                     flag = (mob_countslave (md) <= c2);
                     break;
                 case MSC_ATTACKPCGE:   // attack pc >= num
+                    if (c2 > battle_config.mob_skill_spawn_limit)
+                        c2 = battle_config.mob_skill_spawn_limit;
                     flag = (mob_counttargeted (md, NULL, 0) >= c2);
                     break;
                 case MSC_SKILLUSED:    // specificated skill used
-- 
2.1.0

