From f37617109962a6906f15809bae6a94d3ceee46f5 Mon Sep 17 00:00:00 2001
From: Andrei Karas <akaras@inbox.ru>
Date: Thu, 3 Feb 2011 18:02:28 +0200
Subject: [PATCH 220/226] Prevent silent server termination if no some data.

---
 src/common/grfio.c | 7 ++++++-
 src/map/map.c      | 6 ++++++
 2 files changed, 12 insertions(+), 1 deletion(-)

diff --git a/src/common/grfio.c b/src/common/grfio.c
index 17cdc85..f52bfd0 100644
--- a/src/common/grfio.c
+++ b/src/common/grfio.c
@@ -748,7 +748,7 @@ void *grfio_reads (char *fname, int *size)
     free (buf2);
     if (in != NULL)
         fclose_ (in);
-    exit (1);                   //return NULL;
+    return NULL;
 }
 
 /*==========================================
@@ -1036,6 +1036,11 @@ static void grfio_resourcecheck ()
     FILELIST *entry;
 
     buf = grfio_reads ("data\\resnametable.txt", &size);
+    if (!buf)
+    {
+        printf ("Cant read resnametable.txt\n");
+        exit(1);
+    }
     buf[size] = 0;
 
     for (ptr = buf; ptr - buf < size;)
diff --git a/src/map/map.c b/src/map/map.c
index e155f23..a2b5f15 100644
--- a/src/map/map.c
+++ b/src/map/map.c
@@ -1861,10 +1861,16 @@ static int map_readmap (int m, char *fn, char *alias __attribute__ ((unused)))
 //    int  wh;
     size_t size;
 
+    if (!fn)
+        return -1;
+
     // read & convert fn
     gat = grfio_read (fn);
     if (gat == NULL)
+    {
+        printf ("Cant read map %s\n", fn);
         return -1;
+    }
 
     printf ("\rLoading Maps [%d/%d]: %-50s  ", m, map_num, fn);
     fflush (stdout);
-- 
2.1.0

