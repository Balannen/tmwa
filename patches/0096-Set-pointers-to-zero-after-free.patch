From 40bdd11857967b8a4653dba9743e505d568be4c2 Mon Sep 17 00:00:00 2001
From: Andrei Karas <akaras@inbox.ru>
Date: Wed, 8 Dec 2010 03:07:30 +0200
Subject: [PATCH 096/226] Set pointers to zero after free.

---
 src/common/grfio.c   |  1 +
 src/common/socket.c  | 12 ++++++------
 src/common/timer.c   |  1 +
 src/login/login.c    |  2 ++
 src/map/itemdb.c     |  3 +++
 src/map/magic-expr.c |  1 +
 src/map/magic-stmt.c |  2 ++
 src/map/magic.c      |  1 +
 src/map/map.c        | 27 +++++++++++++++------------
 src/map/npc.c        |  9 ++++++++-
 src/map/script.c     |  1 +
 11 files changed, 41 insertions(+), 19 deletions(-)

diff --git a/src/common/grfio.c b/src/common/grfio.c
index ee37c5b..29210f5 100644
--- a/src/common/grfio.c
+++ b/src/common/grfio.c
@@ -1146,6 +1146,7 @@ void grfio_final (void)
             if (gentry_table[lop] != NULL)
             {
                 free (gentry_table[lop]);
+                gentry_table[lop] = 0;
             }
         }
         free (gentry_table);
diff --git a/src/common/socket.c b/src/common/socket.c
index 82503de..12dcd2e 100644
--- a/src/common/socket.c
+++ b/src/common/socket.c
@@ -362,12 +362,12 @@ int delete_session (int fd)
     FD_CLR (fd, &readfds);
     if (session[fd])
     {
-        if (session[fd]->rdata)
-            free (session[fd]->rdata);
-        if (session[fd]->wdata)
-            free (session[fd]->wdata);
-        if (session[fd]->session_data)
-            free (session[fd]->session_data);
+        free (session[fd]->rdata);
+        session[fd]->rdata = 0;
+        free (session[fd]->wdata);
+        session[fd]->wdata = 0;
+        free (session[fd]->session_data);
+        session[fd]->session_data = 0;
         free (session[fd]);
     }
     session[fd] = NULL;
diff --git a/src/common/timer.c b/src/common/timer.c
index 9002ad7..ee15481 100644
--- a/src/common/timer.c
+++ b/src/common/timer.c
@@ -352,4 +352,5 @@ int do_timer (unsigned int tick)
 void timer_final ()
 {
     free (timer_data);
+    timer_data = 0;
 }
diff --git a/src/login/login.c b/src/login/login.c
index f093108..5b748e0 100644
--- a/src/login/login.c
+++ b/src/login/login.c
@@ -5156,7 +5156,9 @@ void do_final (void)
     mmo_auth_sync ();
 
     free (auth_dat);
+    auth_dat = 0;
     free (gm_account_db);
+    gm_account_db = 0;
     for (i = 0; i < MAX_SERVERS; i++)
     {
         if ((fd = server_fd[i]) >= 0)
diff --git a/src/map/itemdb.c b/src/map/itemdb.c
index 119aa9f..518ef8e 100644
--- a/src/map/itemdb.c
+++ b/src/map/itemdb.c
@@ -723,8 +723,11 @@ static int itemdb_final (void *key __attribute__ ((unused)),
     nullpo_retr (0, id = data);
 
     free (id->use_script);
+    id->use_script = 0;
     free (id->equip_script);
+    id->equip_script = 0;
     free (id->unequip_script);
+    id->unequip_script = 0;
     free (id);
 
     return 0;
diff --git a/src/map/magic-expr.c b/src/map/magic-expr.c
index 807c1d8..41c4a7a 100644
--- a/src/map/magic-expr.c
+++ b/src/map/magic-expr.c
@@ -81,6 +81,7 @@ void magic_clear_var (val_t * v)
     {
         case TY_STRING:
             free (v->v.v_string);
+            v->v.v_string = 0;
             break;
         case TY_AREA:
             free_area (v->v.v_area);
diff --git a/src/map/magic-stmt.c b/src/map/magic-stmt.c
index ac16148..95cf4ba 100644
--- a/src/map/magic-stmt.c
+++ b/src/map/magic-stmt.c
@@ -66,9 +66,11 @@ static void clear_activation_record (cont_activation_record_t * ar)
     {
         case CONT_STACK_FOREACH:
             free (ar->c.c_foreach.entities);
+            ar->c.c_foreach.entities = 0;
             break;
         case CONT_STACK_PROC:
             free (ar->c.c_proc.old_actuals);
+            ar->c.c_proc.old_actuals = 0;
             break;
     }
 }
diff --git a/src/map/magic.c b/src/map/magic.c
index dc914f5..4cd217c 100644
--- a/src/map/magic.c
+++ b/src/map/magic.c
@@ -92,6 +92,7 @@ int magic_message (character_t * caster, char *spell_,
 
     spell = magic_find_spell (spell_invocation);
     free (spell_invocation);
+    spell_invocation = 0;
 
     if (spell)
     {
diff --git a/src/map/map.c b/src/map/map.c
index ecbae49..222fb9c 100644
--- a/src/map/map.c
+++ b/src/map/map.c
@@ -1318,8 +1318,9 @@ int map_quit (struct map_session_data *sd)
     else if (sd->state.storage_flag == 2)
         storage_guild_storage_quit (sd, 1);
 
-    if (sd->npc_stackbuf && sd->npc_stackbuf != NULL)
-        free (sd->npc_stackbuf);
+//    if (sd->npc_stackbuf && sd->npc_stackbuf != NULL)
+    free (sd->npc_stackbuf);
+    sd->npc_stackbuf = 0;
 
     map_delblock (&sd->bl);
 
@@ -1900,6 +1901,7 @@ static int map_readmap (int m, char *fn, char *alias __attribute__ ((unused)))
         }
     }
     free (gat);
+    gat = 0;
 
     map[m].bxs = (xs + BLOCK_SIZE - 1) / BLOCK_SIZE;
     map[m].bys = (ys + BLOCK_SIZE - 1) / BLOCK_SIZE;
@@ -1996,6 +1998,7 @@ int map_readallmap (void)
     }
 
     free (waterlist);
+    waterlist = 0;
     printf ("\rMaps Loaded: %d %60s\n", map_num, "");
     printf ("\rMaps Removed: %d \n", maps_removed);
     return 0;
@@ -2362,16 +2365,16 @@ void do_final (void)
 
     for (i = 0; i <= map_num; i++)
     {
-        if (map[i].gat)
-            free (map[i].gat);
-        if (map[i].block)
-            free (map[i].block);
-        if (map[i].block_mob)
-            free (map[i].block_mob);
-        if (map[i].block_count)
-            free (map[i].block_count);
-        if (map[i].block_mob_count)
-            free (map[i].block_mob_count);
+        free (map[i].gat);
+        map[i].gat = 0;
+        free (map[i].block);
+        map[i].block = 0;
+        free (map[i].block_mob);
+        map[i].block_mob = 0;
+        free (map[i].block_count);
+        map[i].block_count = 0;
+        free (map[i].block_mob_count);
+        map[i].block_mob_count = 0;
     }
     do_final_script ();
     do_final_itemdb ();
diff --git a/src/map/npc.c b/src/map/npc.c
index 485b489..77460f5 100644
--- a/src/map/npc.c
+++ b/src/map/npc.c
@@ -1832,7 +1832,7 @@ static int npc_parse_script (char *w1, char *w2, char *w3, char *w4,
 
         // ���g���Ȃ��̂Ńo�b�t�@����
         free (srcbuf);
-
+        srcbuf = 0;
     }
     else
     {
@@ -2344,6 +2344,7 @@ static void npc_free_internal (struct npc_data *nd)
     else if (nd->bl.subtype == MESSAGE && nd->u.message)
     {
         free (nd->u.message);
+        nd->u.message = 0;
     }
     free (nd);
 }
@@ -2413,9 +2414,15 @@ void ev_release (struct dbn *db, int which)
         return;
 
     if (which & 0x1)
+    {
         free (db->key);
+        db->key = 0;
+    }
     if (which & 0x2)
+    {
         free (db->data);
+        db->data = 0;
+    }
 }
 
 /*==========================================
diff --git a/src/map/script.c b/src/map/script.c
index 99b77ea..567e0cd 100644
--- a/src/map/script.c
+++ b/src/map/script.c
@@ -820,6 +820,7 @@ static int add_str (const unsigned char *p)
         return i;
     }
     free (lowcase);
+    lowcase = 0;
 
     i = calc_hash (p);
     if (str_hash[i] == 0)
-- 
2.1.0

